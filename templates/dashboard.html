{% extends "base.html" %}

{% block content %}

<!-- è‡ªå®šç¾© CSS -->
<style>
    /* Brand Card */
    .brand-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        border: 1px solid #e0e0e0;
        text-align: center;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        height: 100%;
        display: block;
        text-decoration: none;
        color: #333;
    }
    .brand-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: #0d6efd;
        color: #0d6efd;
    }
    .brand-card.active {
        background-color: #e3f2fd;
        border-color: #0d6efd;
        color: #0d6efd;
        font-weight: bold;
    }
    .brand-img-placeholder {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
        color: #adb5bd;
    }
    
    /* è³¼ç‰©è»Šåº•éƒ¨æ‡¸æµ®åˆ— */
    .cart-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #212529; /* æ·±è‰²èƒŒæ™¯ */
        color: white;
        padding: 15px 30px;
        z-index: 1050;
        display: none; /* é è¨­éš±è—ï¼Œæœ‰æ±è¥¿æ‰é¡¯ç¤º */
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }
    
    /* è®“ Cart Bar ä¸æœƒæ“‹åˆ°å·¦é‚Š Sidebar (å¦‚æœæ˜¯æ¡Œé¢ç‰ˆ) */
    @media (min-width: 768px) {
        .cart-bar {
            width: calc(100% - 16.66667%); /* æ‰£é™¤ col-md-2 çš„å¯¬åº¦ */
            left: 16.66667%;
        }
    }

    @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    
    .qty-input { width: 60px; text-align: center; }
</style>

<h2>ğŸ” Equipment Inventory</h2>

<!-- 1. Metrics Row -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="metric-card d-flex align-items-center justify-content-between">
            <div><small class="text-muted">TOTAL ASSETS</small><h2 class="mb-0">{{ total }}</h2></div>
            <div class="fs-1 text-primary">ğŸ“¦</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card d-flex align-items-center justify-content-between">
            <div><small class="text-muted">AVAILABLE</small><h2 class="mb-0 text-success">{{ avail }}</h2></div>
            <div class="fs-1 text-success">âœ…</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card d-flex align-items-center justify-content-between">
            <div><small class="text-muted">UNAVAILABLE</small><h2 class="mb-0 text-warning">{{ loaned }}</h2></div>
            <div class="fs-1 text-warning">â³</div>
        </div>
    </div>
</div>

<!-- 2. Chart & Categories -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card p-3 h-100">
            <h5>Status Distribution</h5>
            <div class="d-flex align-items-center justify-content-center h-100">
                <canvas id="statusChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>ğŸ“‚ Browse by Category</h5>
                {% if curr_cat != 'ALL' %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-danger">Reset All</a>
                {% endif %}
            </div>

            <div class="row g-2">
                {% for cat in ['Lights', 'Camera', 'Digital Tablet', 'Audio', 'VR Headset', 'Stabilizer', 'Tripod', 'Filter', 'Lens', 'DACI Lighting Set', 'DACI Lighting Tripod', 'Others'] %}
                
                {% set icon_url = get_icon_path('cat', cat) %}
                
                <div class="col-4 col-md-2"> <!-- è«‹æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´ col å¤§å° -->
                    <a href="{{ url_for('dashboard', category=cat) }}" 
                       class="btn w-100 h-100 py-3 d-flex flex-column align-items-center justify-content-center {% if curr_cat == cat %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                        {% if icon_url %}
                            <img src="{{ icon_url }}" alt="{{ cat }}" style="width: 50px; height: 50px; object-fit: contain; margin-bottom: 4px;">
                        {% else %}
                            <i class="fas fa-tag mb-2" style="font-size: 24px;"></i> 
                        {% endif %}
                        <small style="line-height: 1.1;">{{ cat }}</small>
                    </a>
                </div>
                {% endfor %}
            </div>

            {% if curr_cat != 'ALL' %}
                <hr>
                <h6 class="text-muted mb-3">Select Brand in <b>{{ curr_cat }}</b>:</h6>
                <div class="row g-3">
                    <div class="col-6 col-sm-4 col-md-3">
                        <a href="{{ url_for('dashboard', category=curr_cat, brand='ALL') }}" 
                           class="brand-card {% if curr_brand == 'ALL' %}active{% endif %}">
                            <div class="brand-img-placeholder"><i class="fas fa-th-large fa-2x"></i></div>
                            <div>All Brands</div>
                        </a>
                    </div>
                    {% for b in brands %}
                    {% set brand_icon_url = get_icon_path('brand', b) %}
                    <div class="col-6 col-sm-4 col-md-3">
                        <a href="{{ url_for('dashboard', category=curr_cat, brand=b) }}" 
                           class="brand-card {% if curr_brand == b %}active{% endif %}">
                            <div class="brand-img-placeholder">
                                {% if brand_icon_url %}
                                    <img src="{{ brand_icon_url }}" style="width: 50px; height: 50px; object-fit: contain;">
                                {% else %}
                                    <i class="fas fa-camera fa-2x"></i>
                                {% endif %}
                            </div>
                            <div>{{ b }}</div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 3. Bottom Section: Items Table -->
<div class="card p-3 mb-5">
    
    <!-- Filter Form -->
    <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3 mb-4 border-bottom pb-3">
        <input type="hidden" name="category" value="{{ curr_cat }}">
        <input type="hidden" name="brand" value="{{ curr_brand }}">
        
        <div class="col-md-3">
            <select name="type" class="form-select" onchange="this.form.submit()">
                <option value="ALL" {% if curr_type == 'ALL' %}selected{% endif %}>All Types</option>
                {% for t in types %}
                    <option value="{{ t }}" {% if curr_type == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="All" {% if curr_status == 'All' %}selected{% endif %}>All Status</option>
                <option value="Available Only" {% if curr_status == 'Available Only' %}selected{% endif %}>Available Only</option>
                <option value="Unavailable Only" {% if curr_status == 'Unavailable Only' %}selected{% endif %}>Unavailable Only</option>
            </select>
        </div>
        
        <div class="col-md-6 d-flex align-items-end justify-content-end">
             <span class="text-muted small">Displaying <b>{{ data|length }}</b> items</span>
        </div>
    </form>

    <!-- Table with Add to Cart Buttons -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th width="20%">Brand / Type</th>
                    <th width="30%">Equipment Name</th>
                    <th width="10%">Total</th>
                    <th width="20%">Availability</th>
                    <th width="20%" class="text-center">Selection</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>
                        <span class="fw-bold text-secondary">{{ row['Brand'] }}</span><br>
                        <small class="text-muted">{{ row['Type'] }}</small>
                    </td>
                    <td><span class="fw-bold fs-5">{{ row['Name'] }}</span></td>
                    <td><span class="badge bg-secondary rounded-pill">{{ row['Total_Qty'] }}</span></td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-success-subtle text-success border border-success">Avail: {{ row['Avail_Qty'] }}</span>
                            {% if row['Loaned_Qty'] > 0 %}
                            <span class="badge bg-warning-subtle text-warning border border-warning">Loaned: {{ row['Loaned_Qty'] }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-center">
                        {% if row['Avail_Qty'] > 0 %}
                        <div class="input-group justify-content-center" style="width: 150px; margin: 0 auto;">
                            <!-- è¼¸å…¥æ•¸é‡ -->
                            <input type="number" id="qty-{{ loop.index }}" class="form-control qty-input" min="0" max="{{ row['Avail_Qty'] }}" value="0">
                            <!-- åŠ å…¥æŒ‰éˆ• -->
                            <button class="btn btn-outline-primary" type="button" 
                                onclick="addToCart('{{ row.Name }}', '{{ row.Brand }}', '{{ row.Type }}', 'qty-{{ loop.index }}')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled>N/A</button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center py-4 text-muted">No items found matching criteria.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 4. Sticky Cart Bar (åº•éƒ¨æ‡¸æµ®) -->
<div id="cartBar" class="cart-bar justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
            <i class="fas fa-shopping-cart text-white"></i>
        </div>
        <div>
            <h5 class="mb-0 text-white">Selection List</h5>
            <small class="text-white-50"><span id="cartCount">0</span> items selected</small>
        </div>
    </div>
    <div>
        <button class="btn btn-outline-light me-2 btn-sm" onclick="clearCart()">Clear</button>
        <button class="btn btn-warning fw-bold px-4" data-bs-toggle="modal" data-bs-target="#checkoutModal" onclick="loadCartToModal()">
            Confirm Request <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<!-- 5. Checkout Modal (ç¢ºèªè¦–çª— + æ—¥æœŸè¼¸å…¥) -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form action="{{ url_for('generate_request') }}" method="POST" target="_blank">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Confirm Request Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- æ—¥æœŸè¼¸å…¥ (å¿…å¡«) -->
                    <div class="row mb-4 bg-light p-3 rounded mx-1 border">
                        <div class="col-md-6 mb-2">
                            <label class="fw-bold mb-1">Expected Loan Date <span class="text-danger">*</span></label>
                            <input type="date" name="expected_loan_date" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="fw-bold mb-1">Expected Return Date <span class="text-danger">*</span></label>
                            <input type="date" name="expected_return_date" class="form-control" required>
                        </div>
                    </div>

                    <h6 class="mb-3 border-bottom pb-2">Selected Equipment</h6>
                    <div id="modalCartContent">
                        <!-- JS æœƒæŠŠè³¼ç‰©è»Šå…§å®¹å¡«å…¥é€™è£¡ -->
                        <p class="text-muted text-center">Loading...</p>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Generate Request Form</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript for Cart Logic -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart.js initialization (Status Chart)
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Available', 'Unavailable'],
            datasets: [{
                data: [{{ avail }}, {{ loaned }}],
                backgroundColor: ['#198754', '#ffc107'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // --- è³¼ç‰©è»Šé‚è¼¯ ---

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ Session Cart
    document.addEventListener('DOMContentLoaded', function() {
        // æˆ‘å€‘å‡è¨­è³¼ç‰©è»Šåˆå§‹ç‹€æ…‹æ˜¯ç©ºçš„ï¼Œæˆ–è€…ä¹‹å¾Œå¯ä»¥åšä¸€å€‹ API è®€å–åˆå§‹ç‹€æ…‹
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘å¦‚æœæœ‰é»æ“Šæ‰é¡¯ç¤ºï¼Œæˆ–è€…é€é template å‚³å…¥è®Šæ•¸
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„ Check
        {% if session.get('cart') %}
            updateCartUI({{ session.get('cart')|length }});
        {% endif %}
    });

    function addToCart(name, brand, type, inputId) {
        const qtyInput = document.getElementById(inputId);
        const qty = parseInt(qtyInput.value);

        if (qty <= 0) {
            alert("Please enter a quantity greater than 0");
            return;
        }

        // ç™¼é€ AJAX è«‹æ±‚
        fetch('/api_update_cart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                brand: brand,
                type: type,
                qty: qty
            })
        })
        .then(response => response.json())
        .then(data => {
            updateCartUI(data.total_items);
            // è¦–è¦ºå›é¥‹ï¼šè®Šæ›´æŒ‰éˆ•é¡è‰²ä¸€ä¸‹
            const btn = qtyInput.nextElementSibling;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.replace('btn-outline-primary', 'btn-success');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.replace('btn-success', 'btn-outline-primary');
            }, 1000);
        });
    }

    function updateCartUI(totalItems) {
        const cartBar = document.getElementById('cartBar');
        const cartCount = document.getElementById('cartCount');
        
        cartCount.innerText = totalItems;
        
        if (totalItems > 0) {
            cartBar.style.display = 'flex'; // é¡¯ç¤º Bar
        } else {
            cartBar.style.display = 'none'; // éš±è— Bar
        }
    }

    function clearCart() {
        if(confirm("Clear all items from selection?")) {
            fetch('/api_clear_cart', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                updateCartUI(0);
                // é‡ç½®æ‰€æœ‰è¼¸å…¥æ¡†
                document.querySelectorAll('.qty-input').forEach(input => input.value = 0);
            });
        }
    }

    // ç•¶æ‰“é–‹ Modal æ™‚ï¼Œè®€å–è³¼ç‰©è»Šå…§å®¹é¡¯ç¤º
    function loadCartToModal() {
        const container = document.getElementById('modalCartContent');
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
        
        // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ fetch å–å¾—æœ€æ–° cart (å› ç‚º /api_update_cart å›å‚³äº† cart)
        // æˆ–è€…æˆ‘å€‘å†æ¬¡å‘¼å«ä¸€å€‹ get_cart APIã€‚ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘ç›´æ¥ç”¨ update_cart ç™¼ä¸€å€‹ dummy request å–å¾—è³‡æ–™
        fetch('/api_update_cart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({qty: 0}) // å‚³é€ 0 ä¸æœƒæ”¹è®Šå…§å®¹ï¼Œåªæœƒå›å‚³ç›®å‰ç‹€æ…‹
        })
        .then(res => res.json())
        .then(data => {
            const cart = data.cart;
            if (Object.keys(cart).length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No items selected.</p>';
                return;
            }

            let html = '<table class="table table-sm table-striped"><thead><tr><th>Item</th><th>Brand</th><th class="text-center">Qty</th></tr></thead><tbody>';
            
            for (const key in cart) {
                const item = cart[key];
                html += `<tr>
                    <td>${item.name}</td>
                    <td><small>${item.brand}</small></td>
                    <td class="text-center fw-bold">${item.qty}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        });
    }
</script>
{% endblock %}